server {
  listen 8443 ssl;
  server_name localhost;

  ssl_certificate     /etc/nginx/certs/dev-cert.pem;
  ssl_certificate_key /etc/nginx/certs/dev-key.pem;

  # Export TLS binding to upstream
  proxy_set_header X-TLS-Session-ID  $ssl_session_id;
  add_header       X-Debug-TLS-Session-ID $ssl_session_id always;

  location / {
    proxy_pass http://app:8080;
    # Explicitly include port in Host to stabilize @authority
    proxy_set_header Host              $host:$server_port;
    proxy_set_header X-Forwarded-Host  $host:$server_port;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Port  $server_port;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # Pass PCH headers to app
    proxy_set_header PCH-Channel-Binding $http_pch_channel_binding;
    proxy_set_header PCH-Challenge       $http_pch_challenge;
    proxy_set_header Signature-Input     $http_signature_input;
    proxy_set_header Signature           $http_signature;
    proxy_set_header Evidence            $http_evidence;
    proxy_set_header Content-Digest      $http_content_digest;
    proxy_set_header Content-Type        $http_content_type;
  }
}
